<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spineless</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- iOS web app meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="spineless">

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" href="favicon.ico">

  <!-- PWA manifest -->
  <link rel="manifest" href="site.webmanifest">

  <!-- Apple touch icons -->
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-v2.png">

  <!-- Tesseract.js (v4) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

  <style>
    :root {
      --bg-dark: #000;
      --pane-dark: #111;
      --pane-darker: #0a0a0a;
      --white: #fff;
      --accent: #ff7a1a;
      --accent-soft: rgba(255, 122, 26, 0.18);
      --search-chrome: #222;
      --search-pill: #1c1c1c;
      --pill-border-subtle: rgba(255, 255, 255, 0.08);
      --pill-text-muted: rgba(255, 255, 255, 0.75);
      --badge-bg: #fff;
      --badge-text: #111;
      --input-bg: #fff;
      --input-text: #111;
      --shadow-soft: 0 18px 38px rgba(0, 0, 0, 0.7);
      --transition-fast: 150ms ease-out;
      --transition-med: 260ms ease-out;
      --crosshair-color: rgba(198, 255, 0, 0.95);
      --crosshair-soft: rgba(198, 255, 0, 0.65);
      --crosshair-fade: rgba(198, 255, 0, 0);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-dark);
      color: var(--white);
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Helvetica Neue", Arial, sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    #app {
      position: relative;
      width: 100%;
      height: 100%;
      max-width: 480px;
      margin: 0 auto;
      background: #000;
      overflow: hidden;
    }

    .screen {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      background: #000;
    }

    .screen.active {
      display: flex;
    }

    /* ADD IMAGE SCREEN */

    #screen-add {
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: #000;
    }

    #screen-add-inner {
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: center;
    }

    #screen-add-inner .app-title {
      font-size: 2.4rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      color: #fff;
    }

    #screen-add-inner .app-subtitle {
      font-size: 1.0rem;
      color: rgba(255, 255, 255, 0.7);
      max-width: 260px;
    }

    #screen-add-inner .add-button-wrapper {
      margin-top: 12px;
    }

    #btn-add-image {
      background: var(--accent);
      border: none;
      color: #fff;
      padding: 16px 32px;
      border-radius: 999px;
      font-size: 1.3rem;
      font-weight: 600;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      min-width: 220px;
    }

    #btn-add-image:active {
      transform: scale(0.97);
    }

    #imageInput {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    /* OCR / SCANNING SCREEN */

    #screen-ocr {
      position: absolute;
      inset: 0;
      overflow: hidden;
      background: #000;
    }

    #ocr-bg {
      position: absolute;
      inset: 0;
      background-position: center center;
      background-size: contain;
      background-repeat: no-repeat;
      filter: brightness(0.4);
      transform-origin: center center;
      transition: transform 260ms ease-out;
    }

    #screen-ocr.scanning-x0 #ocr-bg {
      transform: translateY(0);
    }

    #screen-ocr.scanning-x0 .scan-strip-horizontal {
      animation: scanAcross 1.2s linear forwards;
    }

    #screen-ocr.scanning-x90 #ocr-bg {
      transform: translateX(0);
    }

    #screen-ocr.scanning-x90 .scan-strip-vertical-left {
      animation: scanDown 1.0s linear forwards;
    }

    #screen-ocr.scanning-x-90 #ocr-bg {
      transform: translateX(0);
    }

    #screen-ocr.scanning-x-90 .scan-strip-vertical-right {
      animation: scanDown 1.0s linear forwards;
    }

    .scan-strip {
      position: absolute;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .scan-strip-horizontal {
      left: 0;
      right: 0;
      height: 40vh;
      top: 50%;
      transform: translateY(-50%);
      background: linear-gradient(
        to bottom,
        rgba(232, 255, 41, 0) 0%,
        rgba(232, 255, 41, 0.12) 15%,
        rgba(232, 255, 41, 0.98) 50%,
        rgba(232, 255, 41, 0.2) 80%,
        rgba(232, 255, 41, 0) 100%
      );
      opacity: 0;
    }

    .scan-strip-vertical-left,
    .scan-strip-vertical-right {
      top: 0;
      bottom: 0;
      width: 42vw;
      background: linear-gradient(
        to right,
        rgba(232, 255, 41, 0) 0%,
        rgba(232, 255, 41, 0.12) 20%,
        rgba(232, 255, 41, 0.98) 50%,
        rgba(232, 255, 41, 0.12) 80%,
        rgba(232, 255, 41, 0) 100%
      );
      opacity: 0;
    }

    .scan-strip-vertical-left {
      left: 0;
    }

    .scan-strip-vertical-right {
      right: 0;
    }

    @keyframes scanAcross {
      0% {
        transform: translateY(-55%);
        opacity: 1;
      }
      100% {
        transform: translateY(55%);
        opacity: 0;
      }
    }

    @keyframes scanDown {
      0% {
        transform: translateY(-55%);
        opacity: 1;
      }
      100% {
        transform: translateY(55%);
        opacity: 0;
      }
    }

    #ocr-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .scanning-label {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 22vh;
      font-size: 3.0rem;
      font-weight: 800;
      letter-spacing: 0.04em;
      color: rgba(232, 255, 41, 0.96);
      text-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
      opacity: 1;
      transition: opacity var(--transition-med),
        transform var(--transition-med);
    }

    .orientation-label {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 15vh;
      font-size: 2.2rem;
      font-weight: 600;
      color: rgba(232, 255, 41, 0.96);
      text-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
    }

    .search-container {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18vh;
      width: 86vw;
      max-width: 460px;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-med),
        transform var(--transition-med);
    }

    #screen-ocr.mode-search .scanning-label {
      opacity: 0;
      transform: translate(-50%, 12px);
    }

    #screen-ocr.mode-search .orientation-label {
      opacity: 0;
      transform: translate(-50%, 8px);
    }

    #screen-ocr.mode-search .search-container {
      opacity: 1;
      transform: translate(-50%, 0);
      pointer-events: auto;
    }

    .search-input-wrapper {
      background: rgba(0, 0, 0, 0.92);
      border-radius: 999px;
      padding: 10px 16px 10px 16px;
      display: flex;
      align-items: center;
      box-shadow: var(--shadow-soft);
      border: 1px solid #333;
    }

    .search-input {
      flex: 1;
      border: none;
      background: transparent;
      color: #fff;
      font-size: 1.2rem;
      outline: none;
      padding: 4px 8px;
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.45);
    }

    .autosuggest {
      margin-top: 8px;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.96);
      color: #111;
      max-height: 40vh;
      overflow-y: auto;
      box-shadow: var(--shadow-soft);
      opacity: 0;
      transform: translateY(-8px);
      pointer-events: none;
      transition: opacity var(--transition-fast), transform var(--transition-fast);
    }

    .autosuggest.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .autosuggest-item {
      padding: 12px 18px;
      font-size: 1.4rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      cursor: pointer;
    }

    .autosuggest-item:last-child {
      border-bottom: none;
    }

    .autosuggest-item:hover {
      background: rgba(0, 0, 0, 0.04);
    }

    #ocr-progress {
      position: absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 13px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.8);
      font-size: 0.9rem;
      box-shadow: var(--shadow-soft);
      white-space: nowrap;
    }

    #ocr-progress.hidden {
      display: none;
    }

    /* RESULTS SCREEN */

    #screen-results {
      display: flex;
      flex-direction: column;
      background: #000;
    }

    #results-top-row {
      padding: 16px 16px 8px 16px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
    }

    #btn-new-image {
      background: var(--accent);
      border: none;
      border-radius: 999px;
      padding: 12px 24px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
    }

    #btn-new-image:active {
      transform: scale(0.97);
    }

    #results-image-wrapper {
      flex: 1;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 0 10px 0;
    }

    #results-image-inner {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    #results-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    #highlights-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .crosshair-arm {
      position: absolute;
      width: 120%;
      height: 3px;
      background: linear-gradient(
        to right,
        var(--crosshair-fade),
        var(--crosshair-soft),
        var(--crosshair-color),
        var(--crosshair-soft),
        var(--crosshair-fade)
      );
      transform-origin: center;
      filter: drop-shadow(0 0 18px rgba(198, 255, 0, 0.95));
      opacity: 0.96;
    }

    .crosshair-arm.diag1 {
      transform: rotate(45deg);
    }

    .crosshair-arm.diag2 {
      transform: rotate(-45deg);
    }

    .crosshair-arm-inner {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 40%;
      height: 6px;
      background: #000;
      transform: translate(-50%, -50%);
      border-radius: 999px;
    }

    .crosshair-center-dot {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 3px solid rgba(198, 255, 0, 0.9);
      box-shadow: 0 0 30px rgba(198, 255, 0, 0.9);
      background: rgba(0, 0, 0, 0.7);
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    #results-bottom-row {
      position: relative;
      padding: 0 16px 18px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    #btn-prev,
    #btn-next {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      flex-shrink: 0;
    }

    #btn-prev:active,
    #btn-next:active {
      transform: scale(0.96);
    }

    #results-term-pill {
      position: relative;
      flex: 1;
      max-width: 240px;
      text-align: center;
      padding: 10px 16px;
      border-radius: 999px;
      background: #fff;
      color: #000;
      font-size: 1.15rem;
      font-weight: 600;
      box-shadow: var(--shadow-soft);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #results-badge {
      position: absolute;
      top: -8px;
      right: -6px;
      min-width: 26px;
      height: 26px;
      padding: 0 6px;
      border-radius: 999px;
      background: #fff;
      color: #111;
      font-size: 0.85rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-soft);
      transform: scale(0);
      transform-origin: center;
      transition: transform 160ms ease-out;
    }

    #results-badge.visible {
      transform: scale(1);
    }

    #instance-counter {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.9rem;
    }

    #btn-new-search {
      position: absolute;
      bottom: 10px;
      left: 16px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      font-size: 1.0rem;
      background: #5a3a20;
      color: #fff;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      width: 180px;
      max-width: 220px;
      text-align: center;
    }

    #btn-new-search:active {
      transform: scale(0.97);
    }

    #term-carousel {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 6px;
      max-width: 100%;
    }

    .term-pill {
      min-width: 80px;
      max-width: 160px;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid var(--pill-border-subtle);
      color: var(--pill-text-muted);
      font-size: 1.0rem;
      font-weight: 500;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .term-pill.active {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
      box-shadow: var(--shadow-soft);
    }

    .term-pill.side-pill {
      font-size: 0.85rem;
      max-width: min-content;
      padding-inline: 12px;
      opacity: 0.78;
    }

    #prev-term-pill,
    #next-term-pill {
      cursor: pointer;
    }

    .term-pill.empty {
      opacity: 0.28;
    }

    #bottom-hit-nav {
      position: absolute;
      right: 16px;
      bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #hit-prev,
    #hit-next {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      flex-shrink: 0;
    }

    #hit-prev:active,
    #hit-next:active {
      transform: scale(0.96);
    }

    #hit-index-pill {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: #fff;
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      box-shadow: var(--shadow-soft);
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    #bottom-hit-nav.hidden {
      opacity: 0;
      pointer-events: none;
    }

    @media (max-height: 700px) {
      .scanning-label {
        bottom: 20vh;
        font-size: 2.6rem;
      }
      .search-container {
        bottom: 16vh;
      }
      #term-carousel {
        bottom: 54px;
      }
    }

    #screen-ocr.scanning-x0 .scanning-label,
    #screen-ocr.scanning-x90 .scanning-label,
    #screen-ocr.scanning-x-90 .scanning-label {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="screen-add" class="screen active">
      <div id="screen-add-inner">
        <div class="app-title">spineless</div>
        <div class="app-subtitle">
          Find titles on a shelf by searching the photo.
        </div>
        <div class="add-button-wrapper">
          <button id="btn-add-image">new image</button>
        </div>
      </div>

      <input
        type="file"
        id="imageInput"
        accept="image/*"
        capture="environment"
      />
    </div>

    <div id="screen-ocr" class="screen">
      <div id="ocr-bg"></div>

      <div class="scan-strip scan-strip-horizontal"></div>
      <div class="scan-strip scan-strip-vertical-left"></div>
      <div class="scan-strip scan-strip-vertical-right"></div>

      <div id="ocr-overlay">
        <div id="ocr-progress" class="hidden">scanning…</div>
        <div class="scanning-label">reading</div>
        <div class="orientation-label" id="orientation-label">0°</div>

        <div class="search-container">
          <input
            id="searchInput"
            class="search-input"
            type="text"
            placeholder="search"
            autocomplete="off"
          />
          <div id="autosuggest" class="autosuggest"></div>
        </div>
      </div>
    </div>

    <div id="screen-results" class="screen">
      <div id="results-top-row">
        <button id="btn-new-image">new image</button>
      </div>

      <div id="results-image-wrapper">
        <div id="results-image-inner">
          <img id="results-image" src="" alt="Bookshelf" />
          <div id="highlights-layer"></div>
        </div>
      </div>

      <div id="results-bottom-row">
        <button id="btn-prev">&#8249;</button>

        <div id="results-term-pill">
          <span id="results-term-text"></span>
          <div id="results-badge">1</div>
        </div>

        <button id="btn-next">&#8250;</button>

        <button id="btn-new-search">new search</button>

        <div id="term-carousel">
          <div id="prev-term-pill" class="term-pill side-pill empty"></div>
          <div id="current-term-pill" class="term-pill active"></div>
          <div id="next-term-pill" class="term-pill side-pill empty"></div>
        </div>

        <div id="bottom-hit-nav" class="hidden">
          <button id="hit-prev">&#8249;</button>
          <div id="hit-index-pill">1</div>
          <button id="hit-next">&#8250;</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const screenAdd = document.getElementById("screen-add");
    const screenOCR = document.getElementById("screen-ocr");
    const screenResults = document.getElementById("screen-results");

    const imageInput = document.getElementById("imageInput");
    const btnAddImage = document.getElementById("btn-add-image");
    const btnNewImage = document.getElementById("btn-new-image");
    const btnNewSearch = document.getElementById("btn-new-search");

    const ocrBg = document.getElementById("ocr-bg");
    const ocrProgress = document.getElementById("ocr-progress");
    const searchInput = document.getElementById("searchInput");
    const autosuggestEl = document.getElementById("autosuggest");
    const orientationLabel = document.getElementById("orientation-label");

    const scanStripHorizontal = document.querySelector(
      ".scan-strip-horizontal"
    );
    const scanStripVerticalLeft = document.querySelector(
      ".scan-strip-vertical-left"
    );
    const scanStripVerticalRight = document.querySelector(
      ".scan-strip-vertical-right"
    );

    const resultsImage = document.getElementById("results-image");
    const resultsImageInner = document.getElementById("results-image-inner");
    const highlightsLayer = document.getElementById("highlights-layer");

    const btnPrev = document.getElementById("btn-prev");
    const btnNext = document.getElementById("btn-next");

    const resultsTermPill = document.getElementById("results-term-pill");
    const resultsTermText = document.getElementById("results-term-text");
    const resultsBadge = document.getElementById("results-badge");

    const prevTermPill = document.getElementById("prev-term-pill");
    const currentTermPill = document.getElementById("current-term-pill");
    const nextTermPill = document.getElementById("next-term-pill");

    const bottomHitNav = document.getElementById("bottom-hit-nav");
    const hitPrev = document.getElementById("hit-prev");
    const hitNext = document.getElementById("hit-next");
    const hitIndexPill = document.getElementById("hit-index-pill");

    let ocrWords = [];
    let imageDataUrl = "";

    let termList = [];
    let currentTermIndex = -1;
    let currentTerm = "";

    function normalizeWord(text) {
      return (text || "")
        .trim()
        .toLowerCase()
        .replace(/^[^a-z0-9]+|[^a-z0-9]+$/gi, "")
        .trim();
    }

    function showScreen(el) {
      [screenAdd, screenOCR, screenResults].forEach((s) =>
        s.classList.remove("active")
      );
      el.classList.add("active");
    }

    function resetScanStrips() {
      scanStripHorizontal.style.animation = "none";
      scanStripVerticalLeft.style.animation = "none";
      scanStripVerticalRight.style.animation = "none";
      void scanStripHorizontal.offsetWidth;
      scanStripHorizontal.style.animation = "";
      scanStripVerticalLeft.style.animation = "";
      scanStripVerticalRight.style.animation = "";
    }

    function startScanAnimation() {
      screenOCR.classList.remove("scanning-x0", "scanning-x90", "scanning-x-90");
      resetScanStrips();

      setTimeout(() => {
        screenOCR.classList.add("scanning-x0");
        orientationLabel.textContent = "0°";

        setTimeout(() => {
          screenOCR.classList.remove("scanning-x0");
          screenOCR.classList.add("scanning-x90");
          orientationLabel.textContent = "90°";

          setTimeout(() => {
            screenOCR.classList.remove("scanning-x90");
            screenOCR.classList.add("scanning-x-90");
            orientationLabel.textContent = "-90°";

            setTimeout(() => {
              screenOCR.classList.remove("scanning-x-90");
            }, 1100);
          }, 1100);
        }, 1300);
      }, 200);
    }

    function mapBboxToOriginal(bbox, kind, W, H) {
      const { x0, y0, x1, y1 } = bbox;

      const corners = [
        [x0, y0],
        [x1, y1],
      ];

      function fromBase(u, v) {
        return { x: u, y: v };
      }

      function fromCW(u, v) {
        const x = v;
        const y = H - u;
        return { x, y };
      }

      function fromCCW(u, v) {
        const x = W - v;
        const y = u;
        return { x, y };
      }

      const mapped = corners.map(([u, v]) => {
        if (kind === "base") return fromBase(u, v);
        if (kind === "cw") return fromCW(u, v);
        return fromCCW(u, v);
      });

      const xs = mapped.map((p) => p.x);
      const ys = mapped.map((p) => p.y);

      let nx0 = Math.min(xs[0], xs[1]);
      let ny0 = Math.min(ys[0], ys[1]);
      let nx1 = Math.max(xs[0], xs[1]);
      let ny1 = Math.max(ys[0], ys[1]);

      nx0 = Math.max(0, Math.min(W, nx0));
      nx1 = Math.max(0, Math.min(W, nx1));
      ny0 = Math.max(0, Math.min(H, ny0));
      ny1 = Math.max(0, Math.min(H, ny1));

      return { x0: nx0, y0: ny0, x1: nx1, y1: ny1 };
    }

    function buildTermList() {
      if (!ocrWords.length) {
        termList = [];
        return;
      }

      const cleaned = ocrWords
        .map((w) => normalizeWord(w.text))
        .filter((t) => t && t.length > 1);

      const uniq = Array.from(new Set(cleaned));
      uniq.sort((a, b) => a.localeCompare(b));
      termList = uniq;
    }

    const SHORT_COMMON_WORDS = new Set([
      "and",
      "the",
      "for",
      "from",
      "with",
      "that",
      "this",
      "into",
      "over",
      "under",
      "your",
      "their",
      "book",
      "books",
      "new",
      "old",
      "how",
      "why",
      "what",
      "when",
      "where",
      "who",
      "which",
      "our",
      "out",
      "all",
      "one",
      "two",
      "three",
      "four",
      "five",
      "six",
      "seven",
      "eight",
      "nine",
      "ten",
    ]);

    function isDictionaryWord(word) {
      if (!word) return false;
      const w = word.toLowerCase();
      if (SHORT_COMMON_WORDS.has(w)) return true;
      if (!/^[a-z]+$/.test(w)) return false;
      if (w.length < 3) return false;
      if (!/[aeiouy]/.test(w)) return false;
      return true;
    }

    function findPrevDictIndex(startIndex) {
      if (!termList.length) return -1;
      let idx = startIndex;
      for (let steps = 0; steps < termList.length; steps++) {
        idx = (idx - 1 + termList.length) % termList.length;
        if (isDictionaryWord(termList[idx])) return idx;
      }
      return -1;
    }

    function findNextDictIndex(startIndex) {
      if (!termList.length) return -1;
      let idx = startIndex;
      for (let steps = 0; steps < termList.length; steps++) {
        idx = (idx + 1) % termList.length;
        if (isDictionaryWord(termList[idx])) return idx;
      }
      return -1;
    }

    function updateTermCarousel() {
      if (!termList.length || currentTermIndex < 0) {
        prevTermPill.textContent = "";
        currentTermPill.textContent = "";
        nextTermPill.textContent = "";
        prevTermPill.classList.add("empty");
        currentTermPill.classList.add("empty");
        nextTermPill.classList.add("empty");
        return;
      }

      const current = termList[currentTermIndex];
      currentTermPill.textContent = current;
      currentTermPill.classList.remove("empty");

      const prevIdx = findPrevDictIndex(currentTermIndex);
      const nextIdx = findNextDictIndex(currentTermIndex);

      if (prevIdx !== -1) {
        prevTermPill.textContent = termList[prevIdx];
        prevTermPill.classList.remove("empty");
      } else {
        prevTermPill.textContent = "";
        prevTermPill.classList.add("empty");
      }

      if (nextIdx !== -1) {
        nextTermPill.textContent = termList[nextIdx];
        nextTermPill.classList.remove("empty");
      } else {
        nextTermPill.textContent = "";
        nextTermPill.classList.add("empty");
      }
    }

    function updateAutosuggest(query) {
      if (!query) {
        autosuggestEl.classList.remove("visible");
        autosuggestEl.innerHTML = "";
        return;
      }

      const q = query.toLowerCase();

      const suggestions = termList
        .filter((t) => t.startsWith(q))
        .slice(0, 20);

      if (!suggestions.length) {
        autosuggestEl.classList.remove("visible");
        autosuggestEl.innerHTML = "";
        return;
      }

      autosuggestEl.innerHTML = suggestions
        .map(
          (s) =>
            `<div class="autosuggest-item" data-value="${s}">${s}</div>`
        )
        .join("");
      autosuggestEl.classList.add("visible");
    }

    searchInput.addEventListener("input", (e) => {
      const query = e.target.value.trim();
      updateAutosuggest(query);
    });

    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const term = searchInput.value.trim();
        if (term) {
          autosuggestEl.classList.remove("visible");
          autosuggestEl.innerHTML = "";
          runSearch(term);
        }
      }
    });

    autosuggestEl.addEventListener("click", (e) => {
      const item = e.target.closest(".autosuggest-item");
      if (!item) return;
      const value = item.dataset.value;
      searchInput.value = value;
      autosuggestEl.classList.remove("visible");
      autosuggestEl.innerHTML = "";
      runSearch(value);
    });

    async function startOCR(dataUrl) {
      showScreen(screenOCR);
      screenOCR.classList.remove("mode-search");
      ocrBg.style.backgroundImage = `url(${dataUrl})`;
      ocrProgress.classList.remove("hidden");
      ocrProgress.textContent = "scanning…";

      ocrWords = [];
      termList = [];
      currentTermIndex = -1;
      currentTerm = "";
      clearHighlights();

      startScanAnimation();

      imageDataUrl = dataUrl;

      try {
        const img = new Image();
        img.src = dataUrl;
        await new Promise((resolve, reject) => {
          img.onload = resolve;
          img.onerror = reject;
        });

        const W = img.naturalWidth;
        const H = img.naturalHeight;

        const baseCanvas = document.createElement("canvas");
        baseCanvas.width = W;
        baseCanvas.height = H;
        const baseCtx = baseCanvas.getContext("2d");
        baseCtx.drawImage(img, 0, 0);

        const cwCanvas = document.createElement("canvas");
        cwCanvas.width = H;
        cwCanvas.height = W;
        const cwCtx = cwCanvas.getContext("2d");
        cwCtx.translate(H, 0);
        cwCtx.rotate(Math.PI / 2);
        cwCtx.drawImage(img, 0, 0);

        const ccwCanvas = document.createElement("canvas");
        ccwCanvas.width = H;
        ccwCanvas.height = W;
        const ccwCtx = ccwCanvas.getContext("2d");
        ccwCtx.translate(0, W);
        ccwCtx.rotate(-Math.PI / 2);
        ccwCtx.drawImage(img, 0, 0);

        const passes = [
          { kind: "base", canvas: baseCanvas, label: "0°" },
          { kind: "cw", canvas: cwCanvas, label: "90°" },
          { kind: "ccw", canvas: ccwCanvas, label: "-90°" },
        ];

        let allWords = [];

        for (let i = 0; i < passes.length; i++) {
          const { kind, canvas, label } = passes[i];
          const passIndex = i + 1;
          const passTotal = passes.length;

          orientationLabel.textContent = label;
          ocrProgress.textContent = `scanning ${passIndex}/${passTotal}…`;

          const result = await Tesseract.recognize(canvas, "eng", {
            tessedit_pageseg_mode: 3,
            logger: (m) => {
              if (m.status === "recognizing text") {
                const pct = Math.round((m.progress || 0) * 100);
                ocrProgress.textContent = `scanning ${passIndex}/${passTotal}… ${pct}%`;
              } else {
                ocrProgress.textContent = `scanning ${passIndex}/${passTotal}…`;
              }
            },
          });

          const words = result.data.words || [];
          const mapped = words
            .filter((w) => w.text && w.text.trim().length)
            .map((w) => ({
              text: w.text.trim(),
              bbox: mapBboxToOriginal(w.bbox, kind, W, H),
            }));

          allWords = allWords.concat(mapped);
        }

        ocrWords = allWords;
        buildTermList();
        ocrProgress.classList.add("hidden");

        screenOCR.classList.add("mode-search");
        setTimeout(() => searchInput.focus(), 450);
      } catch (err) {
        console.error(err);
        alert(
          "There was a problem reading the image. Please try another photo."
        );
        ocrProgress.classList.add("hidden");
        showScreen(screenAdd);
      }
    }

    function runSearch(term) {
      if (!ocrWords.length || !termList.length) return;
      const raw = term.trim();
      if (!raw) return;

      const lowerTerm = raw.toLowerCase();

      let idx = termList.findIndex((t) => t === lowerTerm);
      if (idx === -1) {
        idx = termList.findIndex((t) => t.startsWith(lowerTerm));
      }

      if (idx === -1) {
        alert(`No matches found for “${raw}”`);
        return;
      }

      currentTermIndex = idx;
      currentTerm = termList[currentTermIndex];

      setupResultsScreen();
      showScreen(screenResults);
      drawHighlightsForTerm(currentTerm);
    }

    function setupResultsScreen() {
      resultsImage.src = imageDataUrl;

      if (currentTermIndex < 0 || !termList.length) {
        resultsTermText.textContent = "";
        currentTermPill.textContent = "";
        prevTermPill.textContent = "";
        nextTermPill.textContent = "";
        resultsBadge.classList.remove("visible");
        bottomHitNav.classList.add("hidden");
        return;
      }

      const term = termList[currentTermIndex];
      resultsTermText.textContent = term;
      currentTermPill.textContent = term;

      updateTermCarousel();
    }

    function clearHighlights() {
      while (highlightsLayer.firstChild) {
        highlightsLayer.removeChild(highlightsLayer.firstChild);
      }
    }

    function drawHighlightsForTerm(term) {
      if (!term || !ocrWords.length || !resultsImage.src) return;

      const q = normalizeWord(term);

      const matches = ocrWords.filter(
        (w) => normalizeWord(w.text) === q
      );

      clearHighlights();
      if (!matches.length) {
        resultsBadge.classList.remove("visible");
        bottomHitNav.classList.add("hidden");
        return;
      }

      const image = resultsImage;

      if (!image.naturalWidth || !image.naturalHeight) {
        image.onload = () => drawHighlightsForTerm(term);
        return;
      }

      const displayWidth = image.clientWidth;
      const displayHeight = image.clientHeight;
      if (!displayWidth || !displayHeight) return;

      const imgRect = image.getBoundingClientRect();
      const wrapRect = resultsImageInner.getBoundingClientRect();
      const offsetLeft = imgRect.left - wrapRect.left;
      const offsetTop = imgRect.top - wrapRect.top;

      const scaleX = displayWidth / image.naturalWidth;
      const scaleY = displayHeight / image.naturalHeight;

      const positions = matches.map((m) => {
        const { x0, y0, x1, y1 } = m.bbox;
        const cx = (x0 + x1) / 2;
        const cy = (y0 + y1) / 2;

        const px = offsetLeft + cx * scaleX;
        const py = offsetTop + cy * scaleY;

        return { cx, cy, px, py };
      });

      const centerX = offsetLeft + displayWidth / 2;
      const centerY = offsetTop + displayHeight / 2;

      positions.sort((a, b) => {
        const da =
          (a.px - centerX) * (a.px - centerX) +
          (a.py - centerY) * (a.py - centerY);
        const db =
          (b.px - centerX) * (b.px - centerX) +
          (b.py - centerY) * (b.py - centerY);
        return da - db;
      });

      matches.sort((a, b) => {
        const pa = positions[matches.indexOf(a)];
        const pb = positions[matches.indexOf(b)];
        const da =
          (pa.px - centerX) * (pa.px - centerX) +
          (pa.py - centerY) * (pa.py - centerY);
        const db =
          (pb.px - centerX) * (pb.px - centerX) +
          (pb.py - centerY) * (pb.py - centerY);
        return da - db;
      });

      const targetPos = positions[0];
      const crosshairCenterX = targetPos.px;
      const crosshairCenterY = targetPos.py;

      const arm1 = document.createElement("div");
      arm1.className = "crosshair-arm diag1";
      const arm1Inner = document.createElement("div");
      arm1Inner.className = "crosshair-arm-inner";
      arm1.appendChild(arm1Inner);

      const arm2 = document.createElement("div");
      arm2.className = "crosshair-arm diag2";
      const arm2Inner = document.createElement("div");
      arm2Inner.className = "crosshair-arm-inner";
      arm2.appendChild(arm2Inner);

      const centerDot = document.createElement("div");
      centerDot.className = "crosshair-center-dot";

      [arm1, arm2, centerDot].forEach((el) => {
        el.style.left = `${crosshairCenterX}px`;
        el.style.top = `${crosshairCenterY}px`;
      });

      highlightsLayer.appendChild(arm1);
      highlightsLayer.appendChild(arm2);
      highlightsLayer.appendChild(centerDot);

      const hitCount = matches.length;
      if (hitCount > 1) {
        resultsBadge.textContent = `${hitCount}`;
        resultsBadge.classList.add("visible");
        bottomHitNav.classList.remove("hidden");
        hitIndexPill.textContent = "1";
      } else {
        resultsBadge.classList.remove("visible");
        bottomHitNav.classList.add("hidden");
      }

      bottomHitNav.dataset.hitIndex = "0";
      bottomHitNav.dataset.hitCount = String(hitCount);
      bottomHitNav.dataset.term = term;
    }

    function stepHit(delta) {
      const hitCount = Number(bottomHitNav.dataset.hitCount || "0");
      if (!hitCount) return;

      let index = Number(bottomHitNav.dataset.hitIndex || "0");
      index = (index + delta + hitCount) % hitCount;
      bottomHitNav.dataset.hitIndex = String(index);
      hitIndexPill.textContent = String(index + 1);

      const term = bottomHitNav.dataset.term;
      if (!term) return;

      const q = normalizeWord(term);
      const matches = ocrWords.filter(
        (w) => normalizeWord(w.text) === q
      );
      if (!matches.length) return;

      const image = resultsImage;
      const displayWidth = image.clientWidth;
      const displayHeight = image.clientHeight;
      if (!displayWidth || !displayHeight) return;

      const imgRect = image.getBoundingClientRect();
      const wrapRect = resultsImageInner.getBoundingClientRect();
      const offsetLeft = imgRect.left - wrapRect.left;
      const offsetTop = imgRect.top - wrapRect.top;

      const scaleX = displayWidth / image.naturalWidth;
      const scaleY = displayHeight / image.naturalHeight;

      const target = matches[index];
      const { x0, y0, x1, y1 } = target.bbox;
      const cx = (x0 + x1) / 2;
      const cy = (y0 + y1) / 2;

      const px = offsetLeft + cx * scaleX;
      const py = offsetTop + cy * scaleY;

      const arm1 = highlightsLayer.querySelector(".crosshair-arm.diag1");
      const arm2 = highlightsLayer.querySelector(".crosshair-arm.diag2");
      const centerDot = highlightsLayer.querySelector(
        ".crosshair-center-dot"
      );
      if (!arm1 || !arm2 || !centerDot) return;

      [arm1, arm2, centerDot].forEach((el) => {
        el.style.left = `${px}px`;
        el.style.top = `${py}px`;
      });
    }

    hitPrev.addEventListener("click", () => stepHit(-1));
    hitNext.addEventListener("click", () => stepHit(1));

    function goToPrevTerm() {
      if (!termList.length || currentTermIndex < 0) return;

      const prevIdx = findPrevDictIndex(currentTermIndex);
      if (prevIdx === -1) return;

      currentTermIndex = prevIdx;
      currentTerm = termList[currentTermIndex];
      setupResultsScreen();
      drawHighlightsForTerm(currentTerm);
    }

    function goToNextTerm() {
      if (!termList.length || currentTermIndex < 0) return;

      const nextIdx = findNextDictIndex(currentTermIndex);
      if (nextIdx === -1) return;

      currentTermIndex = nextIdx;
      currentTerm = termList[currentTermIndex];
      setupResultsScreen();
      drawHighlightsForTerm(currentTerm);
    }

    btnPrev.addEventListener("click", goToPrevTerm);
    btnNext.addEventListener("click", goToNextTerm);

    let touchStartX = null;

    resultsImageInner.addEventListener("touchstart", (e) => {
      if (e.touches.length === 1) {
        touchStartX = e.touches[0].clientX;
      }
    });

    resultsImageInner.addEventListener("touchend", (e) => {
      if (touchStartX === null) return;
      const dx = e.changedTouches[0].clientX - touchStartX;
      if (Math.abs(dx) > 40) {
        if (dx < 0) {
          goToNextTerm();
        } else {
          goToPrevTerm();
        }
      }
      touchStartX = null;
    });

    prevTermPill.addEventListener("click", () => {
      if (prevTermPill.classList.contains("empty")) return;
      goToPrevTerm();
    });

    nextTermPill.addEventListener("click", () => {
      if (nextTermPill.classList.contains("empty")) return;
      goToNextTerm();
    });

    btnAddImage.addEventListener("click", () => {
      imageInput.click();
    });

    imageInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        startOCR(dataUrl);
      };
      reader.readAsDataURL(file);
    });

    btnNewImage.addEventListener("click", () => {
      showScreen(screenAdd);
      imageInput.value = "";
      ocrWords = [];
      termList = [];
      currentTermIndex = -1;
      currentTerm = "";
      clearHighlights();
    });

    btnNewSearch.addEventListener("click", () => {
      showScreen(screenOCR);
      screenOCR.classList.add("mode-search");
      searchInput.value = "";
      autosuggestEl.classList.remove("visible");
      setTimeout(() => searchInput.focus(), 200);
    });
  </script>
</body>
</html>
